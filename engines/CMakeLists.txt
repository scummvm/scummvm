add_library(engines)
add_library(enabled_engines INTERFACE)
add_library(enabled_engines_detection INTERFACE)

target_sources(
  engines
  PRIVATE achievements.cpp
          advancedDetector.cpp
          dialogs.cpp
          engine.cpp
          game.cpp
          metaengine.cpp
          obsolete.cpp
          savestate.cpp
)

# Generate "engines/plugins_table.h"
file(REMOVE "plugins_table.h")
file(APPEND "plugins_table.h" "/* This file is automatically generated by CMake */\n")

# Generate "engines/detection_table.h"
file(REMOVE "detection_table.h")
file(APPEND "detection_table.h" "/* This file is automatically generated by CMake */\n")

# Add all enabled engines to the enabled_engines target
foreach(engine IN LISTS ENABLED_ENGINES_FINAL)
  string(TOUPPER "${engine}" engine_upper)
  set("ENABLE_${engine_upper}" ON CACHE BOOL INTERNAL "Enable the ${engine} engine")
  add_compile_definitions("ENABLE_${engine_upper}")
  add_subdirectory("${_engine_${engine}_path}")
  target_include_directories("${engine}" PRIVATE "${ENGINES_DIR}")
  target_include_directories("${engine}_detection" PRIVATE "${ENGINES_DIR}")

  # TODO: Fix the definitions and re-add the static/dynamic logic

  # Append to "plugins_table.h" file(APPEND "plugins_table.h" "#if
  # PLUGIN_ENABLED_STATIC(${ENGINE_NAME})\n")
  file(APPEND "plugins_table.h" "LINK_PLUGIN(${engine_upper})\n")
  # file(APPEND "plugins_table.h" "#endif\n")

  # Append to detection_table file(APPEND "detection_table.h" "#if defined(ENABLE_${ENGINE_NAME}) ||
  # defined(DETECTION_FULL)\n")
  file(APPEND "detection_table.h" "LINK_PLUGIN(${engine_upper}_DETECTION)\n")
  # file(APPEND "detection_table.h" "#endif\n")
  target_link_libraries(enabled_engines INTERFACE "${engine}")
  target_link_libraries(enabled_engines_detection INTERFACE "${engine}_detection")
endforeach()

target_link_libraries(engines INTERFACE enabled_engines enabled_engines_detection)
