add_library(engines)
add_library(enabled_engines INTERFACE)
add_library(enabled_engines_detection INTERFACE)

target_sources(
  engines
  PRIVATE achievements.cpp
          advancedDetector.cpp
          dialogs.cpp
          engine.cpp
          game.cpp
          metaengine.cpp
          obsolete.cpp
          savestate.cpp
)

# Generate "engines/plugins_table.h"
file(REMOVE "plugins_table.h")
file(APPEND "plugins_table.h" "/* This file is automatically generated by CMake */\n")

# Generate "engines/detection_table.h"
file(REMOVE "detection_table.h")
file(APPEND "detection_table.h" "/* This file is automatically generated by CMake */\n")

macro(enable_detection engine)
  string(TOUPPER "${engine}" engine_upper)
  target_link_libraries(enabled_engines_detection INTERFACE "${engine}_detection")
  # Append to detection_table
  # file(APPEND "detection_table.h" "#if defined(ENABLE_${engine_upper}) || defined(DETECTION_FULL)\n")
  file(APPEND "detection_table.h" "LINK_PLUGIN(${engine_upper}_DETECTION)\n")
  # file(APPEND "detection_table.h" "#endif\n")
endmacro()

macro(enable_engine engine)
  string(TOUPPER "${engine}" engine_upper)
  target_link_libraries(enabled_engines INTERFACE "${engine}")
  file(APPEND "plugins_table.h" "LINK_PLUGIN(${engine_upper})\n")
endmacro()

# Load all of the engine subfolders
file(GLOB ENGINES "${CMAKE_CURRENT_SOURCE_DIR}/*")
foreach(engine IN LISTS ENGINES)
  if(NOT IS_DIRECTORY "${engine}")
    continue()
  endif()

  cmake_path(GET engine FILENAME engine_name)
  add_subdirectory("${engine_name}" EXCLUDE_FROM_ALL)
  target_include_directories("${engine_name}" PRIVATE "${ENGINES_DIR}")

  if(DETECTION_FULL)
    target_include_directories("${engine_name}_detection" PRIVATE "${ENGINES_DIR}")
    enable_detection("${engine_name}")
  endif()
endforeach()

# # Add all enabled engines to the enabled_engines target
foreach(engine IN LISTS ENABLED_ENGINES_FINAL)
  string(TOUPPER "${engine}" engine_upper)

  # TODO: Fix the definitions and re-add the static/dynamic logic

  # Append to "plugins_table.h"
  # file(APPEND "plugins_table.h" "#if PLUGIN_ENABLED_STATIC(${engine_upper})\n")
  file(APPEND "plugins_table.h" "LINK_PLUGIN(${engine_upper})\n")
  # file(APPEND "plugins_table.h" "#endif\n")
  target_link_libraries(enabled_engines INTERFACE "${_engine_${engine}_folder}")
endforeach()

target_link_libraries(engines PRIVATE enabled_engines enabled_engines_detection)
