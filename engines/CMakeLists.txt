add_library(engines)

target_sources(
  engines
  PRIVATE achievements.cpp
          advancedDetector.cpp
          dialogs.cpp
          engine.cpp
          game.cpp
          metaengine.cpp
          obsolete.cpp
          savestate.cpp
)

# Generate "engines/plugins_table.h"
file(REMOVE "plugins_table.h")
file(APPEND "plugins_table.h" "/* This file is automatically generated by CMake */\n")

# Generate "engines/detection_table.h"
file(REMOVE "detection_table.h")
file(APPEND "detection_table.h" "/* This file is automatically generated by CMake */\n")

# Scan subdirectories for engines

file(
  GLOB engine_dirs
  RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}
  "plumbers/configure.engine"
)
foreach(engine_configure ${engine_dirs})
  get_filename_component(engine_dir ${engine_configure} DIRECTORY)

  string(TOUPPER ${engine_dir} ENGINE_NAME)

  set("ENABLE_${ENGINE_NAME}" STATIC_PLUGIN)
  add_compile_definitions(ENABLE_${ENGINE_NAME})

  # TODO: Fix the definitions and re-add the static/dynamic logic

  # Append to "plugins_table.h" file(APPEND "plugins_table.h" "#if
  # PLUGIN_ENABLED_STATIC(${ENGINE_NAME})\n")
  file(APPEND "plugins_table.h" "LINK_PLUGIN(${ENGINE_NAME})\n")
  # file(APPEND "plugins_table.h" "#endif\n")

  # Append to detection_table file(APPEND "detection_table.h" "#if defined(ENABLE_${ENGINE_NAME}) ||
  # defined(DETECTION_FULL)\n")
  file(APPEND "detection_table.h" "LINK_PLUGIN(${ENGINE_NAME}_DETECTION)\n")
  # file(APPEND "detection_table.h" "#endif\n")

  add_subdirectory(${engine_dir})
  target_link_libraries(engines PRIVATE engine_plumbers)
endforeach()
